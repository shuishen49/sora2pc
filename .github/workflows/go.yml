name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的 tag 时触发，例如 v0.0.2
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
            # 去掉 v 前缀
            VERSION=${VERSION#v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=dev" >> $GITHUB_OUTPUT
            echo "tag=dev" >> $GITHUB_OUTPUT
          fi

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: get-version
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Build Wails application
        run: wails build -platform windows/amd64
      
      - name: Build NSIS installer
        run: wails build -platform windows/amd64 -nsis
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          # 复制安装包
          if (Test-Path "build\bin\sorapc-amd64-installer.exe") {
            Copy-Item "build\bin\sorapc-amd64-installer.exe" "release\sorapc-windows-amd64-installer.exe"
          }
          # 复制可执行文件（便携版）
          if (Test-Path "build\bin\sorapc.exe") {
            Copy-Item "build\bin\sorapc.exe" "release\sorapc-windows-amd64.exe"
          }
          # 创建 ZIP 便携版
          if (Test-Path "build\bin\sorapc.exe") {
            Compress-Archive -Path "build\bin\sorapc.exe" -DestinationPath "release\sorapc-windows-amd64-portable.zip" -Force
          }
        shell: powershell
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: release/*
          retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: get-version
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Build Wails application (AMD64)
        run: |
          wails build -platform darwin/amd64
          if [ -d "build/bin/sorapc.app" ]; then
            cp -R "build/bin/sorapc.app" "build/bin/sorapc-amd64.app"
          fi
      
      - name: Build Wails application (ARM64)
        run: |
          wails build -platform darwin/arm64
          if [ -d "build/bin/sorapc.app" ]; then
            cp -R "build/bin/sorapc.app" "build/bin/sorapc-arm64.app"
          fi
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          # 复制并打包 AMD64 应用
          if [ -d "build/bin/sorapc-amd64.app" ]; then
            cp -R "build/bin/sorapc-amd64.app" "release/sorapc-macos-amd64.app"
            cd release
            zip -r sorapc-macos-amd64.zip sorapc-macos-amd64.app
            cd ..
          fi
          # 复制并打包 ARM64 应用
          if [ -d "build/bin/sorapc-arm64.app" ]; then
            cp -R "build/bin/sorapc-arm64.app" "release/sorapc-macos-arm64.app"
            cd release
            zip -r sorapc-macos-arm64.zip sorapc-macos-arm64.app
            cd ..
          fi
          # 列出所有文件
          ls -la release/
        shell: bash
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: release/*
          retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [get-version, build-windows, build-macos]
    if: github.ref_type == 'tag'
    
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release/windows
      
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release/macos
      
      - name: Prepare all release files
        run: |
          mkdir -p release/all
          cp release/windows/* release/all/ 2>/dev/null || true
          cp release/macos/* release/all/ 2>/dev/null || true
          ls -la release/all/
        shell: bash
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/all/*
          name: Release ${{ needs.get-version.outputs.tag }}
          body: |
            ## 版本 ${{ needs.get-version.outputs.tag }}
            
            ### 下载说明
            
            #### Windows
            - **安装版**：`sorapc-windows-amd64-installer.exe` - 推荐使用，包含自动安装和卸载功能
            - **便携版**：`sorapc-windows-amd64-portable.zip` - 解压即用，无需安装
            
            #### macOS
            - **Intel 芯片**：`sorapc-macos-amd64.zip` - 适用于 Intel Mac（解压后拖拽到 Applications 文件夹）
            - **Apple Silicon**：`sorapc-macos-arm64.zip` - 适用于 M1/M2/M3 Mac（解压后拖拽到 Applications 文件夹）
            
            ### 更新内容
            请查看 [提交记录](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ needs.get-version.outputs.tag }}) 了解详细变更。
            
            ---
            *此版本由 GitHub Actions 自动构建发布*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
